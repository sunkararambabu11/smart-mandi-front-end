<div class="farmer-dashboard">
  <!-- Loading Overlay -->
  @if (isLoading()) {
    <div class="loading-overlay">
      <mat-spinner diameter="48"></mat-spinner>
      <p>Loading dashboard...</p>
    </div>
  }

  <!-- Header Section -->
  <header class="dashboard-header">
    <div class="greeting-section">
      <h1 class="greeting">{{ greeting() }}, {{ userName() }}! ðŸ‘‹</h1>
      <p class="sub-greeting">Here's what's happening with your farm today</p>
    </div>
    <div class="header-actions">
      <button
        mat-icon-button
        class="refresh-btn"
        (click)="onRefresh()"
        matTooltip="Refresh Dashboard"
      >
        <mat-icon>refresh</mat-icon>
      </button>
      @if (lastUpdated()) {
        <span class="last-updated">
          Updated {{ formatRelativeTime(lastUpdated()!) }}
        </span>
      }
    </div>
  </header>

  <!-- Stats Cards -->
  <section class="stats-section">
    <div class="stats-grid">
      @for (stat of statsCards(); track stat.id) {
        <a [routerLink]="stat.route" class="stat-card" [attr.data-color]="stat.color" matRipple>
          <div class="stat-icon">
            <mat-icon>{{ stat.icon }}</mat-icon>
          </div>
          <div class="stat-content">
            <span class="stat-value">
              @if (stat.format === 'currency') {
                {{ formatCurrency(stat.value) }}
              } @else {
                {{ stat.value }}
              }
            </span>
            <span class="stat-title">{{ stat.title }}</span>
          </div>
          <mat-icon class="stat-arrow">chevron_right</mat-icon>
        </a>
      }
    </div>
  </section>

  <!-- Quick Actions -->
  <section class="quick-actions-section">
    <h2 class="section-title">Quick Actions</h2>
    <div class="quick-actions-grid">
      @for (action of quickActions; track action.id) {
        <a [routerLink]="action.route" class="quick-action-btn" [attr.data-color]="action.color" matRipple>
          <mat-icon>{{ action.icon }}</mat-icon>
          <span>{{ action.label }}</span>
        </a>
      }
    </div>
  </section>

  <!-- Main Content Grid -->
  <div class="content-grid">
    <!-- Mandi Prices Section -->
    <section class="mandi-prices-section">
      <div class="section-header">
        <div class="section-title-group">
          <h2 class="section-title">
            <mat-icon>show_chart</mat-icon>
            Today's Mandi Prices
          </h2>
          <span class="section-subtitle">Live rates from nearby mandis</span>
        </div>
        <button mat-icon-button (click)="onRefreshPrices()" matTooltip="Refresh Prices">
          <mat-icon>refresh</mat-icon>
        </button>
      </div>

      <div class="prices-list">
        @for (price of mandiPrices(); track trackByPrice($index, price)) {
          <div class="price-card" [attr.data-trend]="price.trend">
            <div class="price-info">
              <div class="crop-details">
                <span class="crop-name">{{ price.cropName }}</span>
                <span class="crop-local">{{ price.localName }}</span>
              </div>
              <span class="mandi-name">{{ price.mandiName }}</span>
            </div>
            <div class="price-value">
              <span class="current-price">â‚¹{{ price.currentPrice }}/{{ price.unit }}</span>
              <div class="price-change" [class.up]="price.trend === 'up'" [class.down]="price.trend === 'down'">
                @if (price.trend !== 'stable') {
                  <mat-icon>{{ price.trend === 'up' ? 'trending_up' : 'trending_down' }}</mat-icon>
                  <span>{{ price.changePercent > 0 ? '+' : '' }}{{ price.changePercent.toFixed(1) }}%</span>
                } @else {
                  <mat-icon>trending_flat</mat-icon>
                  <span>Stable</span>
                }
              </div>
            </div>
          </div>
        } @empty {
          <div class="empty-state">
            <mat-icon>show_chart</mat-icon>
            <p>No mandi prices available</p>
          </div>
        }
      </div>

      <a routerLink="/mandi-prices" class="view-all-link">
        View All Prices
        <mat-icon>arrow_forward</mat-icon>
      </a>
    </section>

    <!-- Recent Activity Section -->
    <section class="activity-section">
      <div class="section-header">
        <div class="section-title-group">
          <h2 class="section-title">
            <mat-icon [matBadge]="unreadCount()" [matBadgeHidden]="unreadCount() === 0" matBadgeColor="warn" matBadgeSize="small">
              notifications
            </mat-icon>
            Recent Activity
          </h2>
        </div>
        @if (unreadCount() > 0) {
          <button mat-button color="primary" (click)="dashboardService.markAllActivitiesRead()">
            Mark all read
          </button>
        }
      </div>

      <div class="activity-list">
        @for (activity of activities(); track trackByActivity($index, activity)) {
          <div
            class="activity-item"
            [class.unread]="!activity.isRead"
            [attr.data-type]="activity.type"
            (click)="onActivityClick(activity)"
          >
            <div class="activity-icon">
              <mat-icon>{{ getActivityIcon(activity.type) }}</mat-icon>
            </div>
            <div class="activity-content">
              <span class="activity-title">{{ activity.title }}</span>
              <span class="activity-description">{{ activity.description }}</span>
              <span class="activity-time">{{ formatRelativeTime(activity.timestamp) }}</span>
            </div>
            @if (activity.amount) {
              <span class="activity-amount">â‚¹{{ activity.amount | number }}</span>
            }
          </div>
        } @empty {
          <div class="empty-state">
            <mat-icon>inbox</mat-icon>
            <p>No recent activity</p>
          </div>
        }
      </div>

      <a routerLink="/notifications" class="view-all-link">
        View All Activity
        <mat-icon>arrow_forward</mat-icon>
      </a>
    </section>
  </div>
</div>



