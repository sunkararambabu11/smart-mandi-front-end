<div class="user-management-page">
  <!-- Header -->
  <header class="page-header">
    <div class="header-content">
      <h1>User Management</h1>
      <p>Manage platform users, verify accounts, and handle moderation</p>
    </div>
    <button mat-raised-button color="primary">
      <mat-icon>person_add</mat-icon>
      Add User
    </button>
  </header>

  <!-- Stats Cards -->
  <section class="stats-grid">
    <mat-card class="stat-card">
      <mat-icon class="stat-icon total">people</mat-icon>
      <div class="stat-info">
        <span class="stat-value">{{ stats().total }}</span>
        <span class="stat-label">Total Users</span>
      </div>
    </mat-card>
    
    <mat-card class="stat-card">
      <mat-icon class="stat-icon farmers">agriculture</mat-icon>
      <div class="stat-info">
        <span class="stat-value">{{ stats().farmers }}</span>
        <span class="stat-label">Farmers</span>
      </div>
    </mat-card>
    
    <mat-card class="stat-card">
      <mat-icon class="stat-icon buyers">shopping_bag</mat-icon>
      <div class="stat-info">
        <span class="stat-value">{{ stats().buyers }}</span>
        <span class="stat-label">Buyers</span>
      </div>
    </mat-card>
    
    <mat-card class="stat-card">
      <mat-icon class="stat-icon suspended">block</mat-icon>
      <div class="stat-info">
        <span class="stat-value">{{ stats().suspended }}</span>
        <span class="stat-label">Suspended</span>
      </div>
    </mat-card>
  </section>

  <!-- Filters -->
  <mat-card class="filters-card">
    <div class="filters-row">
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Search users</mat-label>
        <input 
          matInput 
          [ngModel]="searchQuery()" 
          (ngModelChange)="searchQuery.set($event)"
          placeholder="Name, email, or phone" />
        <mat-icon matPrefix>search</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Role</mat-label>
        <mat-select [value]="roleFilter()" (selectionChange)="roleFilter.set($event.value)">
          <mat-option value="all">All Roles</mat-option>
          <mat-option value="farmer">Farmers</mat-option>
          <mat-option value="buyer">Buyers</mat-option>
          <mat-option value="admin">Admins</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Status</mat-label>
        <mat-select [value]="statusFilter()" (selectionChange)="statusFilter.set($event.value)">
          <mat-option value="all">All Status</mat-option>
          <mat-option value="active">Active</mat-option>
          <mat-option value="pending">Pending</mat-option>
          <mat-option value="suspended">Suspended</mat-option>
        </mat-select>
      </mat-form-field>
    </div>
  </mat-card>

  <!-- Users Table -->
  <mat-card class="table-card">
    @if (isLoading()) {
      <div class="loading-state">
        <mat-progress-spinner mode="indeterminate" diameter="40"></mat-progress-spinner>
        <p>Loading users...</p>
      </div>
    } @else if (filteredUsers.length === 0) {
      <div class="empty-state">
        <mat-icon>people_outline</mat-icon>
        <h2>No Users Found</h2>
        <p>Try adjusting your search or filters</p>
      </div>
    } @else {
      <div class="table-container">
        <table mat-table [dataSource]="filteredUsers" matSort (matSortChange)="onSort($event)">
          <!-- User Column -->
          <ng-container matColumnDef="user">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>User</th>
            <td mat-cell *matCellDef="let user">
              <div class="user-cell">
                <div class="user-avatar">
                  {{ user.fullName.charAt(0) }}
                </div>
                <div class="user-details">
                  <span class="user-name">
                    {{ user.fullName }}
                    @if (user.verified) {
                      <mat-icon class="verified-icon" matTooltip="Verified">verified</mat-icon>
                    }
                  </span>
                  <span class="user-email">{{ user.email }}</span>
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Role Column -->
          <ng-container matColumnDef="role">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Role</th>
            <td mat-cell *matCellDef="let user">
              <mat-chip class="role-chip" [class]="user.role">
                <mat-icon>{{ getRoleIcon(user.role) }}</mat-icon>
                {{ user.role | titlecase }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
            <td mat-cell *matCellDef="let user">
              <span class="status-badge" [class]="user.status">
                {{ user.status | titlecase }}
              </span>
            </td>
          </ng-container>

          <!-- Joined Column -->
          <ng-container matColumnDef="joined">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Joined</th>
            <td mat-cell *matCellDef="let user">
              {{ user.joinedAt | date:'mediumDate' }}
            </td>
          </ng-container>

          <!-- Activity Column -->
          <ng-container matColumnDef="activity">
            <th mat-header-cell *matHeaderCellDef>Activity</th>
            <td mat-cell *matCellDef="let user">
              <div class="activity-info">
                <span class="orders-count">{{ user.ordersCount }} orders</span>
                <span class="last-active">Last: {{ user.lastActive | date:'short' }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let user">
              <div class="actions-cell">
                <button mat-icon-button matTooltip="View" (click)="onViewUser(user)">
                  <mat-icon>visibility</mat-icon>
                </button>
                <button mat-icon-button [matMenuTriggerFor]="menu">
                  <mat-icon>more_vert</mat-icon>
                </button>
                
                <mat-menu #menu="matMenu">
                  <button mat-menu-item (click)="onEditUser(user)">
                    <mat-icon>edit</mat-icon>
                    <span>Edit</span>
                  </button>
                  @if (!user.verified) {
                    <button mat-menu-item (click)="onVerifyUser(user)">
                      <mat-icon>verified</mat-icon>
                      <span>Verify</span>
                    </button>
                  }
                  @if (user.status === 'active') {
                    <button mat-menu-item (click)="onSuspendUser(user)">
                      <mat-icon>block</mat-icon>
                      <span>Suspend</span>
                    </button>
                  } @else if (user.status === 'suspended') {
                    <button mat-menu-item (click)="onActivateUser(user)">
                      <mat-icon>check_circle</mat-icon>
                      <span>Activate</span>
                    </button>
                  }
                  <mat-divider></mat-divider>
                  <button mat-menu-item class="delete-action" (click)="onDeleteUser(user)">
                    <mat-icon>delete</mat-icon>
                    <span>Delete</span>
                  </button>
                </mat-menu>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </div>

      <mat-paginator
        [length]="totalUsers()"
        [pageSize]="pageSize()"
        [pageSizeOptions]="[5, 10, 25, 50]"
        (page)="onPageChange($event)"
        showFirstLastButtons>
      </mat-paginator>
    }
  </mat-card>
</div>

